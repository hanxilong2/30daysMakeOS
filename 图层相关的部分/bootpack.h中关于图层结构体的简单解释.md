以下是 `bootpack.h` 中与图层（Sheet）相关的核心结构体的详细解析，包含每个成员变量的意义和作用：

---

### **1. `struct SHEET`（单个图层）**
```c
struct SHEET {
    unsigned char *buf;    // 图层的像素缓冲区指针
    int bxsize, bysize;    // 图层的逻辑尺寸（以像素为单位）
    int vx0, vy0;          // 图层在屏幕上的显示位置（左上角坐标）
    int col_inv;           // 透明色编号（该颜色不会被绘制）
    int height;            // 图层当前的高度（-1表示隐藏，值越大越靠前）
    int flags;             // 状态标志（如是否在使用中）
    struct SHTCTL *ctl;    // 关联的图层控制器（SHTCTL）指针
};
```

#### **成员变量详解：**
- **`buf`**  
  - **类型**：`unsigned char *`  
  - **作用**：指向图层像素数据的缓冲区。每个像素值对应调色板中的颜色索引。  
  - **示例**：`buf[y * bxsize + x]` 表示位置 `(x, y)` 的像素颜色。

- **`bxsize`, `bysize`**  
  - **类型**：`int`  
  - **作用**：定义图层的逻辑宽度和高度（单位：像素）。可能与实际显示区域不同（通过 `vx0, vy0` 控制显示位置）。

- **`vx0`, `vy0`**  
  - **类型**：`int`  
  - **作用**：图层在屏幕上的左上角坐标。通过 `sheet_slide()` 函数修改可实现图层移动。

- **`col_inv`**  
  - **类型**：`int`  
  - **作用**：透明色索引。该颜色对应的像素不会被绘制到屏幕上，允许下层图层透出。  
  - **示例**：若 `col_inv = 99`，则缓冲区中值为 `99` 的像素视为透明。

- **`height`**  
  - **类型**：`int`  
  - **作用**：图层的高度（显示优先级）。  
    - `height = -1`：图层隐藏。  
    - `height >= 0`：图层可见，数值越大表示越靠前（顶层）。  
  - **操作**：通过 `sheet_updown()` 调整高度。

- **`flags`**  
  - **类型**：`int`  
  - **作用**：状态标志位，例如 `SHEET_USE` 表示该图层正在使用中。

- **`ctl`**  
  - **类型**：`struct SHTCTL *`  
  - **作用**：指向所属的图层控制器，用于操作全局图层栈。

---

### **2. `struct SHTCTL`（图层控制器）**
```c
struct SHTCTL {
    unsigned char *vram;    // 显存起始地址
    unsigned char *map;     // 像素归属映射表（记录每个像素属于哪个图层）
    int xsize, ysize;       // 屏幕的物理分辨率
    int top;                // 当前顶层图层的高度索引
    struct SHEET *sheets[MAX_SHEETS];      // 按高度排序的图层指针数组
    struct SHEET sheets0[MAX_SHEETS];      // 预分配的图层对象池
};
```

#### **成员变量详解：**
- **`vram`**  
  - **类型**：`unsigned char *`  
  - **作用**：显存起始地址，所有图层的最终像素会合并到此内存区域显示。

- **`map`**  
  - **类型**：`unsigned char *`  
  - **作用**：记录每个屏幕像素当前由哪个图层占据。通过 `sheet_refreshmap()` 更新，用于优化绘制。  
  - **原理**：每个像素位置存储对应图层的索引（例如 `map[y * xsize + x] = sheet_id`）。

- **`xsize`, `ysize`**  
  - **类型**：`int`  
  - **作用**：屏幕的物理分辨率（单位：像素），由初始化时传入的参数确定。

- **`top`**  
  - **类型**：`int`  
  - **作用**：当前显示的最高图层的索引。例如 `top = 3` 表示有 4 个可见图层（0~3）。

- **`sheets[]`**  
  - **类型**：`struct SHEET *[]`  
  - **作用**：按高度从低到高排序的图层指针数组。通过 `sheet_updown()` 维护顺序。

- **`sheets0[]`**  
  - **类型**：`struct SHEET[]`  
  - **作用**：预分配的图层对象池。通过 `sheet_alloc()` 从中分配可用图层。

---

### **3. 图层系统的工作原理**
1. **初始化**  
   - 调用 `shtctl_init()` 创建图层控制器，分配 `map` 和 `sheets0` 内存。
2. **分配图层**  
   - 通过 `sheet_alloc()` 从 `sheets0` 池中获取一个未使用的 `SHEET` 对象。
3. **设置属性**  
   - 使用 `sheet_setbuf()` 绑定缓冲区、尺寸和透明色。
4. **调整高度**  
   - 调用 `sheet_updown()` 修改 `height` 并更新 `sheets[]` 数组的排序。
5. **绘制与刷新**  
   - 通过 `sheet_refresh()` 或 `sheet_refreshsub()` 局部刷新屏幕。
   - 移动图层时，`sheet_slide()` 更新 `vx0, vy0` 并触发新旧区域的重绘。

---

### **关键设计点**
- **透明色处理**：通过 `col_inv` 跳过透明像素，减少不必要的绘制。
- **局部刷新优化**：仅重绘受影响的屏幕区域（通过 `vx0, vy0` 和 `bxsize, bysize` 计算）。
- **映射表加速**：`map` 数组避免逐层检查所有图层的像素，直接确定顶层可见图层。
